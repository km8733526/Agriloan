# AgriLoan Credit Scorer — Backend API

Production-style Python/Flask REST API backend for the Agricultural Loan Credit
Scorer. Integrates with the existing HTML frontend (index.html, result.html,
dashboard.html) via JSON over HTTP.

---

## Project Structure

```
agri-backend/
│
├── app.py                       ← Flask REST API (main entry point)
├── train_model.py               ← ML model training script
├── requirements.txt             ← Python dependencies
├── README.md                    ← This file
│
├── model/
│   └── credit_model.pkl         ← Trained model (generated by train_model.py)
│
├── database/
│   ├── __init__.py
│   ├── init_db.py               ← SQLite schema + connection helpers
│   └── database.db              ← SQLite database (auto-created on startup)
│
└── services/
    ├── __init__.py
    ├── soil_service.py          ← Soil data enrichment (lat/lng → soil props)
    ├── weather_service.py       ← Weather data enrichment (lat/lng → climate)
    ├── scoring_service.py       ← Trust score + risk decision logic
    └── feature_engineering.py  ← Raw form data → ML feature vector
```

---

## Technology Stack

| Layer        | Technology                                          |
|-------------|-----------------------------------------------------|
| Runtime      | Python 3.10+                                       |
| Web Framework| Flask 3.x                                          |
| CORS         | Flask-CORS (manual fallback if not installed)       |
| ML Model     | XGBoost (sklearn GradientBoosting if not installed) |
| ML Pipeline  | scikit-learn (StandardScaler + classifier)          |
| Data         | pandas, numpy                                       |
| Persistence  | SQLite (via sqlite3 stdlib)                         |
| Production   | gunicorn                                            |

---

## Quick Start

### 1. Install dependencies

```bash
pip install -r requirements.txt
```

### 2. Train the ML model

```bash
python train_model.py
```

Output:
```
Model     : XGBoost
Accuracy  : 81.56%
ROC-AUC   : 0.8998
Model saved → model/credit_model.pkl
```

### 3. Start the API server

**Development:**
```bash
python app.py
```

**Production (gunicorn):**
```bash
gunicorn -w 4 -b 0.0.0.0:5000 "app:create_app()"
```

The server starts on `http://localhost:5000`.

---

## API Endpoints

### GET /health
Liveness probe. Returns 200 if API is running and model is trained.

```json
{
  "status":      "running",
  "timestamp":   "2024-01-15T10:30:00+00:00",
  "db_ready":    true,
  "model_ready": true
}
```

---

### POST /evaluate
Submit a loan application and receive credit evaluation.

**Request body:**
```json
{
  "fullName":      "Rajesh Kumar Singh",
  "aadhaar":       "1234-5678-9012",
  "phone":         "9876543210",
  "district":      "nashik",
  "village":       "Yeola",
  "surveyNumber":  "123/45/A",
  "landSize":      8,
  "irrigation":    "drip",
  "ownership":     "owner",
  "primaryCrop":   "cotton",
  "cropDiversity": 3,
  "yield1":        30,
  "yield2":        35,
  "yield3":        38,
  "latitude":      19.99,
  "longitude":     73.78
}
```

**Response (201):**
```json
{
  "application_id":        "#AL0000001",
  "trust_score":           82,
  "risk_level":            "Low",
  "status":                "Approved",
  "repayment_probability": 0.8234,
  "loan_terms": {
    "max_loan_amount_inr": 500000,
    "interest_rate_pct":   7.5,
    "tenure_years":        5
  },
  "emi_monthly": 10012.45,
  "soil_summary": {
    "soil_type":        "Black Cotton",
    "soil_ph":          7.76,
    "nitrogen_level":   "Medium",
    "phosphorus_level": "Medium",
    "potassium_level":  "High",
    "organic_carbon":   0.62
  },
  "weather_summary": {
    "annual_rainfall":     875,
    "temperature_avg":     25.5,
    "temperature_min":     12.0,
    "temperature_max":     38.0,
    "humidity":            65,
    "drought_risk":        "Low",
    "monsoon_reliability": "Good"
  },
  "features_used": { ... }
}
```

**Risk tier rules:**
| Trust Score | Risk Level | Status   |
|-------------|------------|----------|
| 80 – 100    | Low        | Approved |
| 60 – 79     | Medium     | Review   |
| 0  – 59     | High       | Rejected |

---

### GET /applications
Return all loan applications (dashboard view).

**Query parameters:**
| Param     | Type   | Description                            |
|-----------|--------|----------------------------------------|
| status    | string | Filter: Approved / Review / Rejected   |
| district  | string | Filter by district name                |
| search    | string | Search farmer name (partial match)     |
| page      | int    | Page number (default: 1)               |
| per_page  | int    | Records per page (default: 50, max: 200)|

**Response (200):**
```json
{
  "applications": [...],
  "total":    42,
  "page":     1,
  "per_page": 50,
  "pages":    1
}
```

---

### GET /applications/{id}
Return full detail of one application (result page).

```
GET /applications/1
```

**Response (200):** Complete application record including farmer details,
land info, soil/weather data, and ML evaluation results.

---

### GET /stats
Dashboard summary card numbers.

**Response (200):**
```json
{
  "total":           248,
  "approved":        165,
  "review":           52,
  "rejected":         31,
  "avg_trust_score":  74.2
}
```

---

## Database Schema (SQLite)

### farmers
| Column    | Type    | Notes                    |
|-----------|---------|--------------------------|
| id        | INTEGER | PK, autoincrement        |
| full_name | TEXT    | Required                 |
| aadhaar   | TEXT    | Required                 |
| phone     | TEXT    | Required                 |
| district  | TEXT    | Required                 |
| village   | TEXT    | Required                 |
| created_at| TEXT    | datetime('now'), UTC     |

### land_details
| Column        | Type    | Notes                    |
|---------------|---------|--------------------------|
| id            | INTEGER | PK, autoincrement        |
| farmer_id     | INTEGER | FK → farmers.id          |
| survey_number | TEXT    | Required                 |
| land_size     | REAL    | Acres                    |
| irrigation    | TEXT    | drip/canal/borewell/rain-fed |
| ownership     | TEXT    | owner/lease/tenant       |
| latitude      | REAL    | Decimal degrees          |
| longitude     | REAL    | Decimal degrees          |
| created_at    | TEXT    | datetime('now'), UTC     |

### loan_applications
| Column               | Type    | Notes                |
|----------------------|---------|----------------------|
| id                   | INTEGER | PK, autoincrement    |
| farmer_id            | INTEGER | FK → farmers.id      |
| primary_crop         | TEXT    | Required             |
| crop_diversity       | INTEGER | Number of crops      |
| yield_1              | REAL    | Year-1 quintals      |
| yield_2              | REAL    | Year-2 quintals      |
| yield_3              | REAL    | Year-3 quintals      |
| trust_score          | INTEGER | 0–100                |
| risk_level           | TEXT    | Low/Medium/High      |
| repayment_probability| REAL    | 0.0–1.0              |
| status               | TEXT    | Approved/Review/Rejected |
| soil_type            | TEXT    | From soil service    |
| soil_ph              | REAL    | From soil service    |
| annual_rainfall      | INTEGER | mm/year              |
| drought_risk         | TEXT    | Low/Medium/High      |
| created_at           | TEXT    | datetime('now'), UTC |

---

## ML Model Details

**Algorithm:** XGBoost (GradientBoosting fallback)  
**Pipeline:** StandardScaler → XGBoostClassifier  
**Target:** Binary — 1 = repaid loan, 0 = defaulted  
**Training set:** 8,000 synthetic samples  
**Test accuracy:** ~81.6%  
**ROC-AUC:** ~0.90  

**Feature vector (10 features):**

| # | Feature Name       | Description                      |
|---|-------------------|----------------------------------|
| 0 | land_size          | Farm size in acres                |
| 1 | crop_diversity     | Number of crops grown             |
| 2 | average_yield      | 3-year average yield (quintals)   |
| 3 | soil_ph            | Soil pH level                     |
| 4 | rainfall           | Annual rainfall (mm)              |
| 5 | irrigation_score   | 1=rain-fed, 2=borewell, 3=canal, 4=drip |
| 6 | ownership_score    | 1=tenant, 2=lease, 3=owner        |
| 7 | drought_risk_score | 1=low, 2=medium, 3=high           |
| 8 | nitrogen_score     | 1=low, 2=medium, 3=high           |
| 9 | yield_trend        | Slope of 3-year yield series      |

---

## Frontend Integration

Update your frontend `js/app.js` to call the backend instead of using
localStorage. Replace the form submission handler:

```javascript
// In handleFormSubmission(), replace the localStorage block with:
fetch('http://localhost:5000/evaluate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
})
.then(res => res.json())
.then(data => {
    localStorage.setItem('evaluationResult', JSON.stringify(data));
    hideLoadingModal();
    window.location.href = 'result.html';
})
.catch(err => {
    hideLoadingModal();
    showNotification('Server error: ' + err.message, 'error');
});
```

---

## Environment Variables

| Variable         | Default        | Description                    |
|-----------------|----------------|--------------------------------|
| AGRILOAN_PORT   | 5000           | Server listening port          |
| AGRILOAN_DEBUG  | 0              | Set to 1 for debug mode        |
| AGRILOAN_SECRET | auto-generated | Flask secret key               |

---

## Error Responses

All errors return consistent JSON:
```json
{
  "error":     "Human-readable error message",
  "status":    422,
  "timestamp": "2024-01-15T10:30:00+00:00"
}
```

| HTTP Code | Meaning                    |
|-----------|----------------------------|
| 200       | Success (GET)              |
| 201       | Created (POST /evaluate)   |
| 400       | Bad request / invalid JSON |
| 404       | Application not found      |
| 415       | Wrong Content-Type         |
| 422       | Missing / invalid fields   |
| 500       | Internal server error      |
| 503       | Model not trained yet      |